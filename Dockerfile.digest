# -----------------------------------
# AI News Digest Worker + Ollama Setup
# -----------------------------------
FROM ollama/ollama:latest

WORKDIR /app
COPY . /app

# -----------------------------------
# Install Python safely
# -----------------------------------
RUN apt-get update && apt-get install -y python3 python3-pip python3-venv && \
    python3 -m pip install --upgrade --no-cache-dir pip setuptools wheel --break-system-packages && \
    pip install --no-cache-dir --break-system-packages -r requirements-lock.txt || true

EXPOSE 11434

# -----------------------------------
# Reset entrypoint to a shell
# -----------------------------------
ENTRYPOINT ["/bin/bash", "-c"]

# -----------------------------------
# Start Ollama, wait for it to be ready,
# verify it‚Äôs responding, then start digest job
# -----------------------------------
CMD "\
echo 'üîµ Starting Ollama server...' && \
ollama serve & \
sleep 10 && \
echo 'üü¢ Checking Ollama health...' && \
curl -s http://localhost:11434/api/tags || echo '‚ö†Ô∏è Ollama not responding yet' && \
echo 'üì¶ Pulling model gemma3:1b...' && \
ollama pull gemma3:1b && \
echo '‚úÖ Model ready. Launching News Digest...' && \
python /app/app/send_digest.py || echo '‚ö†Ô∏è Digest exited early, restarting Ollama...' && \
tail -f /dev/null"
