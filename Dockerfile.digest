# -----------------------------------
# AI News Digest Worker + Ollama Setup (Final Fixed)
# -----------------------------------
FROM ollama/ollama:latest

WORKDIR /app
COPY . /app

# -----------------------------------
# Install Python dependencies safely
# -----------------------------------
RUN apt-get update && apt-get install -y python3 python3-pip python3-venv && \
    python3 -m pip install --upgrade --no-cache-dir pip setuptools wheel --break-system-packages && \
    pip install --no-cache-dir --break-system-packages -r requirements-lock.txt || true

EXPOSE 11434

# -----------------------------------
# Reset entrypoint to shell
# -----------------------------------
ENTRYPOINT ["/bin/sh", "-c"]

# -----------------------------------
# Start Ollama server and your digest service
# Keep the process running
# -----------------------------------
CMD "\
ollama serve & \
sleep 10 && \
echo 'ðŸŸ¢ Pulling model gemma3:1b...' && \
ollama pull gemma3:1b && \
echo 'âœ… Model ready. Starting News Digest...' && \
python /app/app/send_digest.py & \
tail -f /dev/null"
