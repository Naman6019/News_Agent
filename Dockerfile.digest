# -----------------------------------
# AI News Digest Worker + Ollama Setup (Final)
# -----------------------------------
FROM ollama/ollama:latest

# Set working directory
WORKDIR /app

# Copy your project
COPY . /app

# -----------------------------------
# Install Python and dependencies safely
# -----------------------------------
# Use --break-system-packages to avoid Ubuntuâ€™s PEP 668 issue
RUN apt-get update && apt-get install -y python3 python3-pip python3-venv && \
    python3 -m pip install --upgrade --no-cache-dir pip setuptools wheel --break-system-packages && \
    pip install --no-cache-dir --break-system-packages -r requirements-lock.txt || true

# Expose Ollama API port
EXPOSE 11434

# -----------------------------------
# Reset entrypoint to shell
# (ollama/ollama image sets ENTRYPOINT to "ollama" by default)
# -----------------------------------
ENTRYPOINT ["/bin/sh", "-c"]

# -----------------------------------
# Start Ollama + Model + News Scheduler
# -----------------------------------
CMD "ollama serve & \
sleep 10 && \
echo 'ðŸŸ¢ Starting Ollama model pull...' && \
ollama pull gemma3:1b && \
echo 'âœ… Model ready. Starting News Digest service...' && \
python /app/app/send_digest.py"
